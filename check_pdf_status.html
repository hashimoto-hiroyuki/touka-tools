<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF処理状況チェック</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23667eea'/><circle cx='16' cy='16' r='9' fill='none' stroke='white' stroke-width='2.5'/><path d='M12 16l3 3 5-6' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Yu Gothic UI', 'Meiryo', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        h1 {
            font-size: 20px;
            color: #333;
            margin-bottom: 16px;
        }

        .btn-refresh {
            display: inline-block;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            background: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .btn-refresh:hover {
            opacity: 0.85;
        }
        .btn-refresh:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 0;
        }
        .tab-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            background: #e0e0e0;
            color: #666;
        }
        .tab-btn.active {
            background: #fff;
            color: #e53935;
        }
        .tab-btn.active.processed-tab {
            color: #1976d2;
        }

        .tab-content {
            background: #fff;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            overflow: auto;
            max-height: calc(100vh - 320px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-size: 12px;
            color: #555;
            z-index: 10;
        }
        tbody td {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        tbody tr:hover {
            background: #f5f8ff;
        }

        .status-unprocessed {
            color: #e53935;
            font-weight: bold;
        }
        .status-processed {
            color: #43a047;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 16px;
        }
        .error-msg {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .no-data {
            text-align: center;
            padding: 30px;
            color: #888;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>PDF処理状況チェック</h1>
    <p style="color:#888; font-size:13px; margin-bottom:16px;">Google Drive上のスキャンPDFフォルダを確認し、OCR処理済み／未処理のステータスを一覧表示します。未処理のPDFはOCR読み取りやPDF紐づけで処理してください。</p>

    <button class="btn-refresh" id="refreshBtn" onclick="loadData()">最新データを取得</button>

    <div id="errorArea"></div>

    <div id="tabArea" style="display:none;">
        <div class="tab-bar">
            <button class="tab-btn active" id="tabUnprocessed" onclick="showTab('unprocessed')">未処理 - スキャンPDFフォルダ (<span id="tabUnprocessedCount">0</span>)</button>
            <button class="tab-btn processed-tab" id="tabProcessed" onclick="showTab('processed')">処理済み - 入力済みPDFフォルダ (<span id="tabProcessedCount">0</span>)</button>
        </div>

        <div class="tab-content" id="unprocessedContent">
            <div class="loading" id="loadingMsg">読み込み中...</div>
        </div>
        <div class="tab-content" id="processedContent" style="display:none;">
        </div>
    </div>

    <script>
        const APPS_SCRIPT_API_URL = 'https://script.google.com/a/macros/devine.co.jp/s/AKfycbwKdVVd4zRcGfPVXsm9l-cgQ8Cv6wbTtij1nB-24tZWKHHiwWk1ISQvXq_J5VI7ReIkdQ/exec';

        let currentData = null;

        function loadData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = '取得中...';
            document.getElementById('errorArea').innerHTML = '';

            const callbackName = 'pdfCb_' + Date.now();
            const url = APPS_SCRIPT_API_URL
                + '?action=getUnprocessedPdfs'
                + '&callback=' + callbackName;

            window[callbackName] = function(result) {
                delete window[callbackName];
                if (script.parentNode) document.head.removeChild(script);
                clearTimeout(timeoutId);
                btn.disabled = false;
                btn.textContent = '最新データを取得';

                if (result.success) {
                    currentData = result.data;
                    renderTabs(currentData);
                } else {
                    document.getElementById('errorArea').innerHTML =
                        '<div class="error-msg">エラー: ' + (result.error || '不明なエラー') + '</div>';
                }
            };

            const timeoutId = setTimeout(function() {
                delete window[callbackName];
                if (script.parentNode) document.head.removeChild(script);
                btn.disabled = false;
                btn.textContent = '最新データを取得';
                document.getElementById('errorArea').innerHTML =
                    '<div class="error-msg">通信がタイムアウトしました</div>';
            }, 30000);

            const script = document.createElement('script');
            script.src = url;
            script.onerror = function() {
                delete window[callbackName];
                if (script.parentNode) document.head.removeChild(script);
                clearTimeout(timeoutId);
                btn.disabled = false;
                btn.textContent = '最新データを取得';
                document.getElementById('errorArea').innerHTML =
                    '<div class="error-msg">通信エラーが発生しました</div>';
            };
            document.head.appendChild(script);
        }

        function renderTabs(data) {
            document.getElementById('tabArea').style.display = 'block';
            document.getElementById('tabUnprocessedCount').textContent = data.unprocessedCount;
            document.getElementById('tabProcessedCount').textContent = data.processedCount;

            // 未処理テーブル
            document.getElementById('unprocessedContent').innerHTML = buildTable(data.unprocessed, true);
            // 処理済みテーブル
            document.getElementById('processedContent').innerHTML = buildTable(data.processed, false);
        }

        function buildTable(list, isUnprocessed) {
            if (list.length === 0) {
                return '<div class="no-data">' + (isUnprocessed ? '未処理のPDFはありません' : '処理済みのPDFはありません') + '</div>';
            }

            let html = '<table><thead><tr>';
            html += '<th style="width:40px;">No.</th>';
            html += '<th>ファイル名</th>';
            html += '<th style="width:140px;">作成日時</th>';
            html += '<th style="width:80px;">サイズ</th>';
            html += '<th style="width:80px;">状態</th>';
            html += '</tr></thead><tbody>';

            for (let i = 0; i < list.length; i++) {
                html += '<tr>';
                html += '<td>' + (i + 1) + '</td>';
                html += '<td>' + escapeHtml(list[i].name) + '</td>';
                html += '<td>' + escapeHtml(list[i].date) + '</td>';
                html += '<td>' + list[i].size + ' KB</td>';
                if (isUnprocessed) {
                    html += '<td class="status-unprocessed">未処理</td>';
                } else {
                    html += '<td class="status-processed">処理済み</td>';
                }
                html += '</tr>';
            }

            html += '</tbody></table>';
            return html;
        }

        function showTab(tab) {
            if (tab === 'unprocessed') {
                document.getElementById('tabUnprocessed').classList.add('active');
                document.getElementById('tabProcessed').classList.remove('active');
                document.getElementById('unprocessedContent').style.display = 'block';
                document.getElementById('processedContent').style.display = 'none';
            } else {
                document.getElementById('tabUnprocessed').classList.remove('active');
                document.getElementById('tabProcessed').classList.add('active');
                document.getElementById('unprocessedContent').style.display = 'none';
                document.getElementById('processedContent').style.display = 'block';
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        // 起動時に自動読み込み
        loadData();
    </script>
</body>
</html>
