<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF紐づけツール</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23e65100'/><path d='M8 6h10l6 6v14a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2z' fill='white' opacity='0.9'/><path d='M18 6v6h6' fill='none' stroke='%23e65100' stroke-width='1.5'/><path d='M10 18h8M10 22h5' stroke='%23e65100' stroke-width='1.5' stroke-linecap='round'/></svg>">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Yu Gothic UI', sans-serif;
            background: #f5f5f5;
            padding: 30px 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 28px;
        }
        h1 {
            font-size: 20px;
            color: #333;
            text-align: center;
            margin-bottom: 6px;
        }
        .subtitle {
            text-align: center;
            color: #888;
            font-size: 13px;
            margin-bottom: 20px;
        }
        .step {
            margin-bottom: 20px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .step-title {
            font-size: 14px;
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
        }
        .btn-load {
            padding: 10px 20px;
            font-size: 14px;
            color: #fff;
            background: #2196F3;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-load:hover { background: #1976D2; }
        .btn-load:disabled { background: #ccc; cursor: not-allowed; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        th {
            background: #f0f0f0;
            padding: 8px 6px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        td {
            padding: 7px 6px;
            border-bottom: 1px solid #eee;
        }
        tr.selected {
            background: #bbdefb;
            font-weight: bold;
            border-left: 4px solid #1976D2;
        }
        tr.has-pdf {
            color: #999;
        }
        tr:hover {
            background: #f5f5f5;
            cursor: pointer;
        }
        .pdf-tag {
            display: inline-block;
            padding: 2px 6px;
            background: #4CAF50;
            color: #fff;
            border-radius: 4px;
            font-size: 11px;
        }
        .no-pdf-tag {
            display: inline-block;
            padding: 2px 6px;
            background: #ff9800;
            color: #fff;
            border-radius: 4px;
            font-size: 11px;
        }

        .file-select {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .selected-file {
            font-size: 13px;
            color: #333;
            margin-top: 6px;
        }
        .btn-load-pdf {
            padding: 10px 20px;
            font-size: 14px;
            color: #fff;
            background: #ff9800;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-load-pdf:hover { background: #f57c00; }
        .btn-load-pdf:disabled { background: #ccc; cursor: not-allowed; }
        .pdf-list-area {
            margin-top: 10px;
        }
        .pdf-list-area table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 6px;
        }
        .pdf-list-area th {
            background: #fff3e0;
            color: #e65100;
            padding: 8px 6px;
            text-align: left;
            border-bottom: 2px solid #ffcc80;
            font-size: 12px;
        }
        .pdf-list-area td {
            padding: 7px 6px;
            border-bottom: 1px solid #fff3e0;
        }
        .pdf-list-area tr:hover {
            background: #fff8e1;
            cursor: pointer;
        }
        .pdf-list-area tr.pdf-selected {
            background: #ffe0b2;
            font-weight: bold;
            border-left: 4px solid #ff9800;
        }
        .pdf-count {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        .pdf-search-bar {
            margin-bottom: 8px;
        }
        .pdf-search-bar input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ffcc80;
            border-radius: 6px;
            outline: none;
        }
        .pdf-search-bar input:focus {
            border-color: #ff9800;
            box-shadow: 0 0 0 2px rgba(255,152,0,0.15);
        }
        .unindexed-badge {
            display: inline-block;
            padding: 1px 5px;
            background: #bdbdbd;
            color: #fff;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 4px;
        }
        .indexed-cell {
            color: #333;
        }
        .not-indexed-cell {
            color: #ccc;
        }

        .btn-save {
            display: block;
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background: #4CAF50;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-save:hover { background: #388E3C; }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; }

        .result {
            margin-top: 16px;
            padding: 14px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        .result.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .result.info { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        .filter-row {
            margin-bottom: 8px;
        }
        .filter-row label {
            font-size: 13px;
            margin-right: 8px;
        }
        .filter-row input[type="checkbox"] {
            margin-right: 4px;
        }

        /* 患者データ一覧 */
        .patient-detail-panel {
            margin-top: 12px;
            padding: 14px;
            background: #f9fbff;
            border: 1px solid #d0d8f0;
            border-radius: 8px;
            display: none;
        }
        .patient-detail-panel.visible { display: block; }
        .patient-detail-panel .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .patient-detail-panel .panel-title {
            font-size: 14px;
            font-weight: bold;
            color: #1976D2;
        }
        .patient-detail-panel .panel-close {
            padding: 2px 10px;
            font-size: 12px;
            color: #888;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        .patient-detail-panel .panel-close:hover { background: #f0f0f0; }
        .patient-detail-panel .detail-table-wrap {
            max-height: 280px;
            overflow-y: auto;
        }
        .patient-detail-panel table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 0;
        }
        .patient-detail-panel th {
            background: #e3eaf8;
            color: #3a5599;
            padding: 5px 10px;
            text-align: left;
            font-size: 12px;
            white-space: nowrap;
            width: 40%;
            border-bottom: 1px solid #d0d8f0;
        }
        .patient-detail-panel td {
            padding: 5px 10px;
            border-bottom: 1px solid #e8ecf4;
            word-break: break-all;
        }
        .patient-detail-panel .loading-msg {
            text-align: center;
            color: #888;
            padding: 16px;
            font-size: 13px;
        }

        /* 比較ビュー（アンケート内容 + PDFプレビュー横並び） */
        .compare-view {
            display: none;
            margin-top: 12px;
            gap: 12px;
        }
        .compare-view.visible {
            display: flex;
        }
        .compare-left {
            flex: 1;
            min-width: 0;
        }
        .compare-right {
            flex: 1;
            min-width: 0;
        }
        .compare-panel {
            border: 1px solid #d0d8f0;
            border-radius: 8px;
            background: #f9fbff;
            overflow: hidden;
        }
        .compare-panel .cp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #e3eaf8;
            border-bottom: 1px solid #d0d8f0;
        }
        .compare-panel .cp-title {
            font-size: 14px;
            font-weight: bold;
            color: #1976D2;
        }
        .compare-panel .cp-close {
            padding: 2px 10px;
            font-size: 12px;
            color: #888;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        .compare-panel .cp-close:hover { background: #f0f0f0; }
        .compare-panel .cp-body {
            padding: 0;
        }
        .compare-panel .detail-table-wrap-compare {
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }
        .compare-panel .detail-table-wrap-compare table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 0;
        }
        .compare-panel .detail-table-wrap-compare th {
            background: #e3eaf8;
            color: #3a5599;
            padding: 5px 10px;
            text-align: left;
            font-size: 12px;
            white-space: nowrap;
            width: 40%;
            border-bottom: 1px solid #d0d8f0;
        }
        .compare-panel .detail-table-wrap-compare td {
            padding: 5px 10px;
            border-bottom: 1px solid #e8ecf4;
            word-break: break-all;
        }
        .pdf-preview-panel {
            border: 1px solid #ffcc80;
            border-radius: 8px;
            background: #fffaf3;
            overflow: hidden;
        }
        .pdf-preview-panel .pp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #fff3e0;
            border-bottom: 1px solid #ffcc80;
        }
        .pdf-preview-panel .pp-title-area {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        .pdf-preview-panel .pp-title {
            font-size: 14px;
            font-weight: bold;
            color: #e65100;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pdf-preview-panel .pp-nav-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            font-size: 18px;
            color: #e65100;
            background: #fff;
            border: 1px solid #ffcc80;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.15s, box-shadow 0.15s;
            user-select: none;
        }
        .pdf-preview-panel .pp-nav-btn:hover {
            background: #ffe0b2;
            box-shadow: 0 1px 4px rgba(230,81,0,0.15);
        }
        .pdf-preview-panel .pp-nav-btn:disabled {
            color: #ccc;
            border-color: #e0e0e0;
            background: #f5f5f5;
            cursor: not-allowed;
            box-shadow: none;
        }
        .pdf-preview-panel .pp-counter {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .pdf-preview-panel .pp-body {
            padding: 0;
        }
        .pdf-preview-panel iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .pdf-preview-panel .pp-placeholder {
            text-align: center;
            color: #aaa;
            padding: 40px 16px;
            font-size: 14px;
        }

        /* === インデックス機能 === */
        .step2-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .btn-index-batch {
            padding: 10px 20px;
            font-size: 14px;
            color: #fff;
            background: #ef6c00;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-index-batch:hover { background: #e65100; }
        .btn-index-batch:disabled { background: #ccc; cursor: not-allowed; }

        .index-stats-bar {
            display: none;
            margin-top: 8px;
            padding: 6px 12px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 6px;
            font-size: 12px;
            color: #795548;
        }
        .index-stats-bar span { font-weight: bold; }

        .index-progress-area {
            display: none;
            margin-top: 10px;
            padding: 14px;
            background: #fff;
            border: 1px solid #ffe0b2;
            border-radius: 8px;
        }
        .idx-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .idx-progress-text {
            font-size: 13px;
            color: #666;
        }
        .idx-progress-bar-wrap {
            background: #e0e0e0;
            border-radius: 6px;
            height: 20px;
            overflow: hidden;
            margin: 8px 0;
        }
        .idx-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffb74d, #ef6c00);
            border-radius: 6px;
            transition: width 0.4s ease;
            width: 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            min-width: 30px;
        }
        .idx-progress-log {
            max-height: 180px;
            overflow-y: auto;
            font-size: 12px;
            color: #555;
            margin-top: 8px;
            border-top: 1px solid #eee;
            padding-top: 8px;
        }
        .idx-progress-log div {
            padding: 2px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .idx-log-ok { color: #2e7d32; }
        .idx-log-err { color: #c62828; }

        .btn-idx-stop {
            padding: 6px 16px;
            font-size: 12px;
            color: #c62828;
            background: #fff;
            border: 1px solid #ef9a9a;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-idx-stop:hover { background: #ffebee; }

        .btn-idx-inline {
            padding: 3px 10px;
            font-size: 11px;
            font-weight: 600;
            color: #ef6c00;
            background: #fff;
            border: 1px solid #ffcc80;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-idx-inline:hover { background: #fff3e0; }
        .btn-idx-inline:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-idx-rerun {
            color: #999;
            border-color: #ddd;
        }
        .btn-idx-rerun:hover { background: #f5f5f5; color: #666; }

        /* === 自動候補バー === */
        .auto-candidate-bar {
            display: none;
            margin-top: 10px;
            padding: 10px 14px;
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            font-size: 13px;
            color: #2e7d32;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .auto-candidate-bar.visible {
            display: flex;
        }
        .auto-candidate-bar .candidate-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        .auto-candidate-bar .candidate-info {
            flex: 1;
            min-width: 0;
        }
        .auto-candidate-bar .candidate-score {
            display: inline-block;
            padding: 2px 8px;
            background: #4CAF50;
            color: #fff;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 6px;
        }
        .auto-candidate-bar .candidate-file {
            font-weight: bold;
        }
        .auto-candidate-bar .candidate-detail {
            color: #558b2f;
            font-size: 12px;
        }
        .auto-candidate-bar .candidate-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .btn-adopt {
            padding: 5px 14px;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            background: #4CAF50;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-adopt:hover { background: #388E3C; }
        .btn-dismiss {
            padding: 5px 14px;
            font-size: 12px;
            color: #888;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-dismiss:hover { background: #f0f0f0; }

        /* === 抜去位置入力 === */
        .extraction-input-area {
            margin-bottom: 12px;
            padding: 14px;
            background: #fce4ec;
            border: 1px solid #ef9a9a;
            border-radius: 8px;
            display: none;
        }
        .extraction-input-area.visible { display: block; }
        .extraction-input-area .ext-title {
            font-size: 14px;
            font-weight: bold;
            color: #c62828;
            margin-bottom: 10px;
        }
        .extraction-input-area .ext-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .extraction-input-area .ext-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .extraction-input-area .ext-label {
            font-size: 13px;
            color: #555;
            font-weight: bold;
        }
        .extraction-input-area .ext-checkbox-group {
            display: flex;
            gap: 8px;
        }
        .extraction-input-area .ext-checkbox-group label {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 13px;
            cursor: pointer;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            transition: background 0.15s, border-color 0.15s;
        }
        .extraction-input-area .ext-checkbox-group label:hover {
            background: #fff3e0;
        }
        .extraction-input-area .ext-checkbox-group input[type="checkbox"]:checked + span {
            font-weight: bold;
            color: #c62828;
        }
        .extraction-input-area .ext-checkbox-group label:has(input:checked) {
            background: #ffcdd2;
            border-color: #ef9a9a;
        }
        .extraction-input-area input[type="text"] {
            width: 80px;
            padding: 5px 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .extraction-input-area input[type="text"]:focus {
            border-color: #c62828;
            outline: none;
            box-shadow: 0 0 0 2px rgba(198,40,40,0.15);
        }
        .extraction-input-area .ext-preview {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
        .extraction-input-area .ext-preview strong {
            color: #c62828;
        }
        .extraction-input-area .ext-note {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        @media (max-width: 900px) {
            .compare-view.visible {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF紐づけツール</h1>
        <p class="subtitle">フォーム回答にスキャンPDFを紐づけます</p>

        <!-- Step 1: データ一覧読み込み -->
        <div class="step">
            <div class="step-title">① データ一覧を読み込み</div>
            <button class="btn-load" id="loadBtn" onclick="loadNoList()">一覧を読み込む</button>

            <div class="filter-row" id="filterRow" style="display:none; margin-top:10px;">
                <label><input type="checkbox" id="filterNoPdf" checked onchange="renderTable()"> PDF未紐づけのみ表示</label>
            </div>

            <div id="tableArea"></div>

        </div>

        <!-- 比較ビュー（アンケート内容 + PDFプレビュー横並び） -->
        <div class="compare-view" id="compareView">
            <!-- 左: アンケート内容 -->
            <div class="compare-left">
                <div class="compare-panel">
                    <div class="cp-header">
                        <span class="cp-title" id="comparePanelTitle">No.? のアンケート内容</span>
                        <button class="cp-close" onclick="closeCompareView()">✕ 閉じる</button>
                    </div>
                    <div class="cp-body">
                        <div class="detail-table-wrap-compare" id="compareDetailWrap">
                            <div style="text-align:center; color:#888; padding:16px;">データ行を選択してください</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 右: PDFプレビュー -->
            <div class="compare-right">
                <div class="pdf-preview-panel">
                    <div class="pp-header">
                        <div class="pp-title-area">
                            <button class="pp-nav-btn" id="pdfPrevBtn" onclick="navigatePdf(-1)" disabled title="前のPDF">&#9664;</button>
                            <span class="pp-title" id="pdfPreviewTitle">PDFプレビュー</span>
                            <button class="pp-nav-btn" id="pdfNextBtn" onclick="navigatePdf(1)" disabled title="次のPDF">&#9654;</button>
                            <span class="pp-counter" id="pdfCounter"></span>
                        </div>
                    </div>
                    <div class="pp-body" id="pdfPreviewBody">
                        <div class="pp-placeholder">② でPDFファイルを選択するとここにプレビューが表示されます</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Google DriveからPDF選択 -->
        <div class="step">
            <div class="step-title">② Google DriveからPDFを選択</div>
            <div class="step2-actions">
                <button class="btn-load-pdf" id="loadPdfBtn" onclick="loadDrivePdfList()">Drive PDF一覧を読み込む</button>
                <button class="btn-index-batch" id="btnIndexBatch" onclick="startBatchIndex()" disabled>未処理を一括インデックス (<span id="unindexedCount">0</span>件)</button>
            </div>
            <div class="index-stats-bar" id="indexStatsBar">
                合計: <span id="statTotal">-</span> 件 ／ インデックス済: <span id="statIndexed">-</span> 件 ／ 未処理: <span id="statUnindexed">-</span> 件
            </div>
            <div class="index-progress-area" id="indexProgressArea">
                <div class="idx-progress-header">
                    <span class="idx-progress-text" id="indexProgressText">処理中...</span>
                    <button class="btn-idx-stop" onclick="stopBatchIndex()">中止</button>
                </div>
                <div class="idx-progress-bar-wrap">
                    <div class="idx-progress-bar" id="indexProgressBar">0%</div>
                </div>
                <div class="idx-progress-log" id="indexProgressLog"></div>
            </div>
            <div class="auto-candidate-bar" id="autoCandidateBar">
                <span class="candidate-icon">&#128269;</span>
                <div class="candidate-info">
                    <span class="candidate-score" id="candidateScore"></span>
                    <span class="candidate-file" id="candidateFile"></span>
                    <span class="candidate-detail" id="candidateDetail"></span>
                </div>
                <div class="candidate-actions">
                    <button class="btn-adopt" onclick="adoptCandidate()">候補を採用</button>
                    <button class="btn-dismiss" onclick="dismissAutoCandidate()">無視</button>
                </div>
            </div>
            <div class="pdf-list-area" id="pdfListArea"></div>
        </div>

        <!-- Step 3: 紐づけ実行 -->
        <div class="step">
            <div class="step-title">③ 紐づけ実行</div>
            <div id="selectionSummary" style="margin-bottom:12px; padding:10px; background:#e3f2fd; border-radius:6px; font-size:14px; display:none;"></div>

            <!-- 抜去位置入力エリア -->
            <div class="extraction-input-area" id="extractionInputArea">
                <div class="ext-title">【質問14】歯の抜去位置（医師入力）</div>
                <div class="ext-row">
                    <div class="ext-group">
                        <span class="ext-label">左右:</span>
                        <div class="ext-checkbox-group">
                            <label><input type="checkbox" id="extRight" onchange="updateExtractionPreview()"><span>右</span></label>
                            <label><input type="checkbox" id="extLeft" onchange="updateExtractionPreview()"><span>左</span></label>
                        </div>
                    </div>
                    <div class="ext-group">
                        <span class="ext-label">上下:</span>
                        <div class="ext-checkbox-group">
                            <label><input type="checkbox" id="extUpper" onchange="updateExtractionPreview()"><span>上</span></label>
                            <label><input type="checkbox" id="extLower" onchange="updateExtractionPreview()"><span>下</span></label>
                        </div>
                    </div>
                    <div class="ext-group">
                        <span class="ext-label">番号:</span>
                        <input type="text" id="extNumber" placeholder="例: 6" oninput="updateExtractionPreview()">
                    </div>
                </div>
                <div class="ext-preview" id="extractionPreview">抜去位置: <strong>（未入力）</strong></div>
                <div class="ext-note">※ PDFを確認して入力してください。空欄でも紐づけは実行できます。</div>
            </div>

            <button class="btn-save" id="saveBtn" onclick="executeLinkPdf()" disabled>紐づける</button>
        </div>

        <div class="result" id="resultArea"></div>
    </div>

    <script>
        const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbzQCrKRX7nJgryTPsP2Aceh4_Ofyef2Ez2iBmHUGBYF3K15XYZk-5Na8XDIlLCqlAGtVQ/exec';

        let noListData = [];
        let selectedNo = null;
        let selectedRow = null;
        let drivePdfList = [];
        let selectedDriveFile = null; // { fileId, fileName }
        let isIndexing = false;   // 一括インデックス処理中フラグ
        let stopIndexing = false; // 一括処理中止フラグ

        // === JSONP汎用API呼び出し（インデックス機能用） ===
        function callApi(action, params, callback, timeoutMs) {
            timeoutMs = timeoutMs || 30000;
            var cbName = 'cb_' + action + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            var url = APPS_SCRIPT_API_URL + '?callback=' + cbName + '&action=' + action;
            if (params) {
                for (var k in params) {
                    url += '&' + k + '=' + encodeURIComponent(params[k]);
                }
            }
            var script;
            var timer = setTimeout(function() {
                delete window[cbName];
                if (script && script.parentNode) script.parentNode.removeChild(script);
                callback({ success: false, error: 'タイムアウト (' + (timeoutMs / 1000) + '秒)' });
            }, timeoutMs);

            window[cbName] = function(data) {
                clearTimeout(timer);
                delete window[cbName];
                if (script && script.parentNode) script.parentNode.removeChild(script);
                callback(data);
            };
            script = document.createElement('script');
            script.src = url;
            script.onerror = function() {
                clearTimeout(timer);
                delete window[cbName];
                if (script.parentNode) script.parentNode.removeChild(script);
                callback({ success: false, error: 'ネットワークエラー' });
            };
            document.head.appendChild(script);
        }

        // === インデックス統計更新 ===
        function updateIndexStats() {
            var total = drivePdfList.length;
            var indexed = 0;
            for (var i = 0; i < drivePdfList.length; i++) {
                if (drivePdfList[i].indexed) indexed++;
            }
            var unindexed = total - indexed;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statIndexed').textContent = indexed;
            document.getElementById('statUnindexed').textContent = unindexed;
            document.getElementById('unindexedCount').textContent = unindexed;
            document.getElementById('indexStatsBar').style.display = total > 0 ? 'block' : 'none';

            var batchBtn = document.getElementById('btnIndexBatch');
            batchBtn.disabled = (unindexed === 0) || isIndexing;
        }

        // === 個別PDFインデックス ===
        function indexOnePdf(fileId, buttonEl) {
            if (buttonEl) {
                buttonEl.disabled = true;
                buttonEl.textContent = '処理中...';
            }
            callApi('indexPdfWithGemini', { fileId: fileId }, function(data) {
                if (!data.success || !data.data || !data.data.success) {
                    var msg = (data.data && data.data.message) || data.error || 'インデックスエラー';
                    showIndexResult('error', msg);
                    if (buttonEl) { buttonEl.disabled = false; buttonEl.textContent = '実行'; }
                    return;
                }
                // ローカルデータを更新
                var r = data.data;
                for (var i = 0; i < drivePdfList.length; i++) {
                    if (drivePdfList[i].fileId === fileId) {
                        drivePdfList[i].indexed = true;
                        drivePdfList[i].hospital = r.ocrData.hospital || '';
                        drivePdfList[i].patientId = r.ocrData.patientId || '';
                        drivePdfList[i].patientName = r.ocrData.patientName || '';
                        drivePdfList[i].birthdate = r.ocrData.birthdate || '';
                        break;
                    }
                }
                updateIndexStats();
                renderPdfList();
                showIndexResult('success', (r.fileName || '') + ' のインデックスが完了しました');
            }, 120000);
        }

        // === 一括インデックス ===
        function startBatchIndex() {
            var unindexed = drivePdfList.filter(function(p) { return !p.indexed; });
            if (unindexed.length === 0) return;

            isIndexing = true;
            stopIndexing = false;
            document.getElementById('btnIndexBatch').disabled = true;
            document.getElementById('loadPdfBtn').disabled = true;

            var progressArea = document.getElementById('indexProgressArea');
            var progressBar = document.getElementById('indexProgressBar');
            var progressText = document.getElementById('indexProgressText');
            var progressLog = document.getElementById('indexProgressLog');
            progressArea.style.display = 'block';
            progressLog.innerHTML = '';

            var total = unindexed.length;
            var current = 0;
            var successCount = 0;
            var errorCount = 0;

            function processNext() {
                if (stopIndexing || current >= total) {
                    var status = stopIndexing ? '中止しました' : '完了';
                    progressText.textContent = status + ': ' + successCount + '件成功 / ' + errorCount + '件エラー';
                    progressBar.style.width = '100%';
                    progressBar.textContent = stopIndexing ? '中止' : '100%';
                    isIndexing = false;
                    stopIndexing = false;
                    document.getElementById('loadPdfBtn').disabled = false;
                    updateIndexStats();
                    return;
                }

                var pdf = unindexed[current];

                // バッチ処理中に個別ボタンで既にインデックス済みならスキップ
                if (pdf.indexed) {
                    current++;
                    setTimeout(processNext, 50);
                    return;
                }

                var pct = Math.round((current / total) * 100);
                progressText.textContent = '処理中 (' + (current + 1) + '/' + total + '): ' + pdf.fileName;
                progressBar.style.width = pct + '%';
                progressBar.textContent = pct + '%';

                callApi('indexPdfWithGemini', { fileId: pdf.fileId }, function(data) {
                    current++;
                    var logDiv = document.createElement('div');

                    if (data.success && data.data && data.data.success) {
                        successCount++;
                        var r = data.data;
                        logDiv.className = 'idx-log-ok';
                        logDiv.textContent = '[OK] ' + pdf.fileName + ' \u2192 ' +
                            (r.ocrData.hospital || '?') + ' / ' +
                            (r.ocrData.patientName || '?');
                        // ローカルデータを更新
                        for (var i = 0; i < drivePdfList.length; i++) {
                            if (drivePdfList[i].fileId === pdf.fileId) {
                                drivePdfList[i].indexed = true;
                                drivePdfList[i].hospital = r.ocrData.hospital || '';
                                drivePdfList[i].patientId = r.ocrData.patientId || '';
                                drivePdfList[i].patientName = r.ocrData.patientName || '';
                                drivePdfList[i].birthdate = r.ocrData.birthdate || '';
                                break;
                            }
                        }
                    } else {
                        errorCount++;
                        var msg = (data.data && data.data.message) || data.error || 'エラー';
                        logDiv.className = 'idx-log-err';
                        logDiv.textContent = '[ERR] ' + pdf.fileName + ': ' + msg;
                    }

                    progressLog.appendChild(logDiv);
                    progressLog.scrollTop = progressLog.scrollHeight;
                    renderPdfList();
                    updateIndexStats();
                    setTimeout(processNext, 300);
                }, 120000);
            }

            processNext();
        }

        function stopBatchIndex() {
            stopIndexing = true;
        }

        // インデックス結果メッセージ表示
        function showIndexResult(type, message) {
            var area = document.getElementById('resultArea');
            area.className = 'result ' + type;
            area.textContent = message;
            area.style.display = 'block';
            if (type === 'success') {
                setTimeout(function() { area.style.display = 'none'; }, 5000);
            }
        }

        // === あいまい検索によるPDF自動候補 ===
        let selectedPatientInfo = null; // { name, birthdate, hospital, id }
        let autoCandidatePdf = null;    // 自動候補のPDFオブジェクト

        // カタカナ類似文字グループ（search_sample.htmlから移植）
        var SIMILAR_CHARS = [
            'アカガ', 'イキギ', 'ウクグ', 'エケゲ', 'オコゴ',
            'サザ', 'シジ', 'スズ', 'セゼ', 'ソゾ',
            'タダ', 'チヂ', 'ツヅッ', 'テデ', 'トド',
            'ハバパ', 'ヒビピ', 'フブプ', 'ヘベペ', 'ホボポ',
            'ヤャ', 'ユュ', 'ヨョ',
            'ワヮ',
            'オウ', 'エイ',
            'ヅズ', 'ヂジ'
        ];

        function isSimilarChar(a, b) {
            if (a === b) return true;
            for (var i = 0; i < SIMILAR_CHARS.length; i++) {
                if (SIMILAR_CHARS[i].indexOf(a) >= 0 && SIMILAR_CHARS[i].indexOf(b) >= 0) return true;
            }
            return false;
        }

        // カタカナ正規化（スペース・記号除去）
        function normalizeKana(str) {
            if (!str) return '';
            return String(str).replace(/[\s\u3000\-\.\・]/g, '');
        }

        // カタカナあいまいマッチ（1文字違いまで許容）
        function fuzzyMatchKana(a, b) {
            var na = normalizeKana(a);
            var nb = normalizeKana(b);
            if (!na || !nb) return { match: false, exact: false, score: 0 };

            // 完全一致
            if (na === nb) return { match: true, exact: true, score: 40 };

            // 部分文字列一致（片方がもう片方を含む）
            if (na.indexOf(nb) >= 0 || nb.indexOf(na) >= 0) {
                return { match: true, exact: false, score: 25 };
            }

            // あいまいマッチ（文字数が近い場合のみ）
            if (Math.abs(na.length - nb.length) > 2) return { match: false, exact: false, score: 0 };

            var longer = na.length >= nb.length ? na : nb;
            var shorter = na.length >= nb.length ? nb : na;
            var diffCount = 0;
            var si = 0;
            for (var li = 0; li < longer.length && si < shorter.length; li++) {
                if (isSimilarChar(longer[li], shorter[si])) {
                    si++;
                } else {
                    diffCount++;
                    if (diffCount > 1) return { match: false, exact: false, score: 0 };
                    // 挿入の場合：longerだけ進む（siは進めない）
                    // 次が一致するか確認
                    if (li + 1 < longer.length && isSimilarChar(longer[li + 1], shorter[si])) {
                        continue; // liだけ進んでsiはそのまま
                    }
                    si++; // 置換として扱う
                }
            }
            diffCount += (longer.length - li) + (shorter.length - si);
            if (diffCount <= 1) return { match: true, exact: false, score: 20 };
            return { match: false, exact: false, score: 0 };
        }

        // 生年月日を正規化 → { year, month, day } （西暦）
        function normalizeBirthdate(str) {
            if (!str) return null;
            var s = String(str);

            // 元号パターン: 昭和35年12月16日, 平成20年7月23日, 令和02年7月5日
            var eraMatch = s.match(/(明治|大正|昭和|平成|令和)\s*(\d{1,2})\s*年\s*(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
            if (eraMatch) {
                var eraOffsets = { '明治': 1867, '大正': 1911, '昭和': 1925, '平成': 1988, '令和': 2018 };
                var westernYear = eraOffsets[eraMatch[1]] + parseInt(eraMatch[2]);
                return { year: westernYear, month: parseInt(eraMatch[3]), day: parseInt(eraMatch[4]) };
            }

            // 西暦パターン: 1960年12月16日 or 1960/12/16
            var westernMatch = s.match(/(\d{4})\s*[年\/\-]\s*(\d{1,2})\s*[月\/\-]\s*(\d{1,2})/);
            if (westernMatch) {
                return { year: parseInt(westernMatch[1]), month: parseInt(westernMatch[2]), day: parseInt(westernMatch[3]) };
            }

            return null;
        }

        // 生年月日スコア（最大30点）
        function scoreBirthdate(bd1, bd2) {
            var n1 = normalizeBirthdate(bd1);
            var n2 = normalizeBirthdate(bd2);
            if (!n1 || !n2) return 0;

            if (n1.year === n2.year && n1.month === n2.month && n1.day === n2.day) return 30;
            if (n1.year === n2.year && n1.month === n2.month) return 15;
            if (n1.year === n2.year) return 5;
            return 0;
        }

        // 医療機関名スコア（最大20点）
        function scoreHospital(h1, h2) {
            if (!h1 || !h2) return 0;
            var s1 = String(h1).replace(/[\s\u3000]/g, '');
            var s2 = String(h2).replace(/[\s\u3000]/g, '');
            if (!s1 || !s2) return 0;

            if (s1 === s2) return 20;
            if (s1.indexOf(s2) >= 0 || s2.indexOf(s1) >= 0) return 20;
            // 先頭3文字以上一致
            var minLen = Math.min(s1.length, s2.length, 3);
            if (minLen >= 3 && s1.substring(0, minLen) === s2.substring(0, minLen)) return 10;
            return 0;
        }

        // 患者IDスコア（最大10点）
        function scorePatientId(id1, id2) {
            if (!id1 || !id2) return 0;
            var s1 = String(id1).replace(/[\s\-]/g, '').toUpperCase();
            var s2 = String(id2).replace(/[\s\-]/g, '').toUpperCase();
            if (!s1 || !s2) return 0;

            if (s1 === s2) return 10;
            if (s1.indexOf(s2) >= 0 || s2.indexOf(s1) >= 0) return 5;
            return 0;
        }

        // PDF1件のマッチスコア計算（最大100点）
        function scorePdfMatch(pdf, patientInfo) {
            if (!pdf.indexed) return 0;
            var nameScore = fuzzyMatchKana(pdf.patientName, patientInfo.name).score;
            var bdScore = scoreBirthdate(pdf.birthdate, patientInfo.birthdate);
            var hospScore = scoreHospital(pdf.hospital, patientInfo.hospital);
            var idScore = scorePatientId(pdf.patientId, patientInfo.id);
            return nameScore + bdScore + hospScore + idScore;
        }

        // viewDataレスポンスから患者情報を抽出
        function extractPatientInfo(headers, row) {
            var info = { name: '', birthdate: '', hospital: '', id: '' };

            // 生年月日は4カラムに分割されている場合がある
            // "4. 生年月日 - 年号" → 昭和, 平成, etc.
            // "5. - 年（半角数字）" → 35
            // "6. - 月（半角数字）" → 12
            // "7. - 日（半角数字）" → 16
            var bdEra = '', bdYear = '', bdMonth = '', bdDay = '';

            for (var i = 0; i < headers.length; i++) {
                var h = headers[i];
                var v = (row[i] !== undefined && row[i] !== null) ? String(row[i]) : '';

                // 患者名（カタカナ氏名）
                // ヘッダー例: "3. 名前（カタカナ）"
                if (h.indexOf('名前') >= 0 || h.indexOf('カタカナ') >= 0 ||
                    h.indexOf('氏名') >= 0 || h.indexOf('お名前') >= 0) {
                    if (v && !info.name) info.name = v;
                }

                // 生年月日 - 年号（分割カラム対応）
                // ヘッダー例: "4. 生年月日 - 年号"
                if (h.indexOf('生年月日') >= 0 && h.indexOf('年号') >= 0) {
                    if (v) bdEra = v;
                }
                // 年（分割カラム対応）
                // ヘッダー例: "5. - 年（半角数字）"
                else if (/^\d*\.\s*-?\s*年/.test(h) || (h.indexOf('年') >= 0 && h.indexOf('半角数字') >= 0 && h.indexOf('月') < 0 && h.indexOf('日') < 0)) {
                    if (v) bdYear = v;
                }
                // 月（分割カラム対応）
                // ヘッダー例: "6. - 月（半角数字）"
                else if (/^\d*\.\s*-?\s*月/.test(h) || (h.indexOf('月') >= 0 && h.indexOf('半角数字') >= 0 && h.indexOf('年') < 0 && h.indexOf('日') < 0)) {
                    if (v) bdMonth = v;
                }
                // 日（分割カラム対応）
                // ヘッダー例: "7. - 日（半角数字）"
                else if (/^\d*\.\s*-?\s*日/.test(h) || (h.indexOf('日') >= 0 && h.indexOf('半角数字') >= 0 && h.indexOf('年') < 0 && h.indexOf('月') < 0)) {
                    if (v) bdDay = v;
                }
                // 生年月日が1カラムにまとまっている場合のフォールバック
                else if (h.indexOf('生年月日') >= 0 && h.indexOf('年号') < 0) {
                    if (v && !info.birthdate) info.birthdate = v;
                }

                // 医療機関名
                // ヘッダー例: "1. 受診中の歯科医院を選んでください。"
                if (h.indexOf('歯科医院') >= 0 || h.indexOf('医療機関') >= 0 || h.indexOf('受診中') >= 0) {
                    if (v && !info.hospital) info.hospital = v;
                }

                // 患者ID
                // ヘッダー例: "2. ID番号"
                if (h.indexOf('ID') >= 0 || h.indexOf('id') >= 0 || h.indexOf('ＩＤ') >= 0) {
                    if (v && !info.id) info.id = v;
                }
            }

            // 分割された生年月日カラムを結合
            if (bdEra && bdYear && !info.birthdate) {
                info.birthdate = bdEra + bdYear + '年' + (bdMonth || '?') + '月' + (bdDay || '?') + '日';
            }

            console.log('[extractPatientInfo]', info);
            return info;
        }

        // 自動マッチング実行
        function autoMatchPdf() {
            if (!selectedPatientInfo || drivePdfList.length === 0) return;

            var bestScore = 0;
            var bestPdf = null;
            var bestIdx = -1;

            for (var i = 0; i < drivePdfList.length; i++) {
                var score = scorePdfMatch(drivePdfList[i], selectedPatientInfo);
                if (score > bestScore) {
                    bestScore = score;
                    bestPdf = drivePdfList[i];
                    bestIdx = i;
                }
            }

            console.log('[autoMatchPdf] bestScore:', bestScore, 'bestPdf:', bestPdf ? bestPdf.fileName : 'none');

            if (bestScore >= 20 && bestPdf) {
                autoCandidatePdf = bestPdf;
                autoCandidatePdf._score = bestScore;
                autoCandidatePdf._originalIndex = bestIdx;
                showAutoCandidate(bestPdf, bestScore);
                // 自動的にPDFを仮選択
                selectDrivePdf(bestIdx);
            } else {
                dismissAutoCandidate();
            }
        }

        // 自動候補バーを表示
        function showAutoCandidate(pdf, score) {
            var bar = document.getElementById('autoCandidateBar');
            document.getElementById('candidateScore').textContent = score + '点';
            document.getElementById('candidateFile').textContent = pdf.fileName;
            document.getElementById('candidateDetail').textContent =
                ' \u2014 ' + (pdf.patientName || '?') + ' / ' + (pdf.hospital || '?') + ' / ' + (pdf.birthdate || '?');
            bar.className = 'auto-candidate-bar visible';
        }

        // 自動候補バーを非表示
        function dismissAutoCandidate() {
            document.getElementById('autoCandidateBar').className = 'auto-candidate-bar';
            autoCandidatePdf = null;
        }

        // 候補を採用（既に仮選択済みなので確認メッセージだけ）
        function adoptCandidate() {
            if (autoCandidatePdf) {
                showIndexResult('success', autoCandidatePdf.fileName + ' を候補として採用しました');
                document.getElementById('autoCandidateBar').className = 'auto-candidate-bar';
            }
        }

        // ① データ一覧読み込み
        function loadNoList() {
            const loadBtn = document.getElementById('loadBtn');
            loadBtn.disabled = true;
            loadBtn.textContent = '読み込み中...';

            const callbackName = 'listCallback_' + Date.now();
            const url = APPS_SCRIPT_API_URL + '?action=getNoList&callback=' + callbackName;

            window[callbackName] = function(result) {
                delete window[callbackName];
                document.head.removeChild(script);
                clearTimeout(timeoutId);
                loadBtn.disabled = false;
                loadBtn.textContent = '一覧を読み込む';

                if (result.success) {
                    noListData = result.data;
                    document.getElementById('filterRow').style.display = 'block';
                    renderTable();
                } else {
                    document.getElementById('tableArea').innerHTML = '<p style="color:red;">読み込みエラー: ' + result.error + '</p>';
                }
            };

            const timeoutId = setTimeout(function() {
                delete window[callbackName];
                if (script.parentNode) document.head.removeChild(script);
                loadBtn.disabled = false;
                loadBtn.textContent = '一覧を読み込む';
                document.getElementById('tableArea').innerHTML = '<p style="color:red;">タイムアウトしました。</p>';
            }, 30000);

            const script = document.createElement('script');
            script.src = url;
            script.onerror = function() {
                delete window[callbackName];
                if (script.parentNode) document.head.removeChild(script);
                clearTimeout(timeoutId);
                loadBtn.disabled = false;
                loadBtn.textContent = '一覧を読み込む';
                document.getElementById('tableArea').innerHTML = '<p style="color:red;">通信エラー</p>';
            };
            document.head.appendChild(script);
        }

        function renderTable() {
            const filterNoPdf = document.getElementById('filterNoPdf').checked;
            let filtered = noListData;
            if (filterNoPdf) {
                filtered = noListData.filter(item => !item.pdfFilename);
            }

            if (filtered.length === 0) {
                document.getElementById('tableArea').innerHTML = filterNoPdf
                    ? '<p style="margin-top:10px; color:#888;">PDF未紐づけのデータはありません。</p>'
                    : '<p style="margin-top:10px; color:#888;">データがありません。</p>';
                return;
            }

            let html = '<table><tr><th>No.</th><th>ID</th><th>医療機関</th><th>PDF</th></tr>';
            for (const item of filtered) {
                const isSelected = selectedNo === item.no;
                const hasPdf = !!item.pdfFilename;
                let rowClass = '';
                if (isSelected) rowClass = 'selected';
                else if (hasPdf) rowClass = 'has-pdf';

                const pdfCell = hasPdf
                    ? '<span class="pdf-tag">済</span> ' + item.pdfFilename
                    : '<span class="no-pdf-tag">未</span>';

                html += '<tr class="' + rowClass + '" onclick="selectRow(' + item.no + ', ' + item.row + ')">';
                html += '<td>' + item.no + '</td>';
                html += '<td>' + (item.id || '-') + '</td>';
                html += '<td>' + (item.hospital || '-') + '</td>';
                html += '<td>' + pdfCell + '</td>';
                html += '</tr>';
            }
            html += '</table>';
            document.getElementById('tableArea').innerHTML = html;
        }

        function selectRow(no, row) {
            selectedNo = no;
            selectedRow = row;
            renderTable();
            updateSaveButton();
            loadPatientDetail(no);
            // PDF一覧が未読み込みなら自動的に読み込む（あいまい検索のため）
            if (drivePdfList.length === 0) {
                loadDrivePdfList();
            }
        }

        // 選択されたNo.のアンケート全データを取得して比較ビューに表示
        function loadPatientDetail(no) {
            var compareView = document.getElementById('compareView');
            var wrap = document.getElementById('compareDetailWrap');
            var title = document.getElementById('comparePanelTitle');

            title.textContent = 'No.' + no + ' のアンケート内容';
            wrap.innerHTML = '<div style="text-align:center; color:#888; padding:16px;">読み込み中...</div>';
            compareView.className = 'compare-view visible';

            var cbName = 'detailCb_' + Date.now();
            var url = APPS_SCRIPT_API_URL + '?action=viewData&password=' + encodeURIComponent('touka2026') + '&callback=' + cbName;

            window[cbName] = function(result) {
                delete window[cbName];
                if (detailScript.parentNode) document.head.removeChild(detailScript);
                clearTimeout(detailTimeout);

                if (!result.success) {
                    wrap.innerHTML = '<div style="text-align:center; color:red; padding:16px;">エラー: ' + (result.error || '不明') + '</div>';
                    return;
                }

                var headers = result.data.headers;
                var noIdx = headers.indexOf('No.');
                var found = false;

                for (var i = 0; i < result.data.rows.length; i++) {
                    var row = result.data.rows[i];
                    if (String(row[noIdx]) === String(no)) {
                        wrap.innerHTML = buildDetailTable(headers, row);
                        found = true;
                        // 患者情報を抽出してPDF自動マッチング
                        selectedPatientInfo = extractPatientInfo(headers, row);
                        autoMatchPdf();
                        break;
                    }
                }

                if (!found) {
                    wrap.innerHTML = '<div style="text-align:center; color:#888; padding:16px;">No.' + no + ' のデータが見つかりません</div>';
                }
            };

            var detailTimeout = setTimeout(function() {
                delete window[cbName];
                if (detailScript.parentNode) document.head.removeChild(detailScript);
                wrap.innerHTML = '<div style="text-align:center; color:#888; padding:16px;">タイムアウトしました</div>';
            }, 30000);

            var detailScript = document.createElement('script');
            detailScript.src = url;
            detailScript.onerror = function() {
                delete window[cbName];
                if (detailScript.parentNode) document.head.removeChild(detailScript);
                clearTimeout(detailTimeout);
                wrap.innerHTML = '<div style="text-align:center; color:red; padding:16px;">通信エラー</div>';
            };
            document.head.appendChild(detailScript);
        }

        function buildDetailTable(headers, row) {
            var html = '<table>';
            for (var i = 0; i < headers.length; i++) {
                var val = (row[i] !== undefined && row[i] !== null && row[i] !== '') ? String(row[i]) : '-';
                html += '<tr><th>' + escapeHtml(headers[i]) + '</th><td>' + escapeHtml(val) + '</td></tr>';
            }
            html += '</table>';
            return html;
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function closeCompareView() {
            document.getElementById('compareView').className = 'compare-view';
        }

        // PDFプレビューを表示
        function showPdfPreview(fileId, fileName) {
            var body = document.getElementById('pdfPreviewBody');
            var title = document.getElementById('pdfPreviewTitle');
            title.textContent = fileName;
            body.innerHTML = '<iframe src="https://drive.google.com/file/d/' + fileId + '/preview" allow="autoplay"></iframe>';

            // 比較ビューを表示
            var compareView = document.getElementById('compareView');
            compareView.className = 'compare-view visible';
        }

        // PDFプレビューをクリア
        function clearPdfPreview() {
            var body = document.getElementById('pdfPreviewBody');
            var title = document.getElementById('pdfPreviewTitle');
            title.textContent = 'PDFプレビュー';
            body.innerHTML = '<div class="pp-placeholder">② でPDFファイルを選択するとここにプレビューが表示されます</div>';
            currentPdfIndex = -1;
            updatePdfNavButtons();
        }

        // ② Google DriveからPDF一覧を読み込み
        function loadDrivePdfList() {
            var btn = document.getElementById('loadPdfBtn');
            var area = document.getElementById('pdfListArea');
            btn.disabled = true;
            btn.textContent = '読み込み中...';
            area.innerHTML = '<div style="color:#888; padding:10px;">読み込み中...</div>';

            console.log('[loadDrivePdfList] API呼び出し開始');
            callApi('getDrivePdfList', {}, function(result) {
                console.log('[loadDrivePdfList] 応答受信:', result ? 'OK' : 'null');
                btn.disabled = false;
                btn.textContent = 'Drive PDF一覧を読み込む';

                if (!result.success) {
                    area.innerHTML = '<div style="color:red;">エラー: ' + (result.error || '不明') + '</div>';
                    return;
                }

                drivePdfList = result.data || [];
                console.log('[loadDrivePdfList] PDF件数:', drivePdfList.length);
                updateIndexStats();
                renderPdfList();
                // PDF一覧読み込み完了後、患者情報があれば自動マッチング実行
                if (selectedPatientInfo) {
                    autoMatchPdf();
                }
            }, 60000);
        }

        // フィルタ済みPDFリスト（ナビゲーション用）
        var filteredPdfList = [];

        function renderPdfList() {
            var area = document.getElementById('pdfListArea');
            if (drivePdfList.length === 0) {
                area.innerHTML = '<div style="color:#888; padding:10px;">フォルダ内にPDFファイルはありません。</div>';
                filteredPdfList = [];
                return;
            }

            // 検索フィルタ（既存の入力値を保持）
            var existingSearch = area.querySelector('#pdfSearchInput');
            var searchTerm = existingSearch ? existingSearch.value : '';

            // フィルタリング
            filteredPdfList = [];
            for (var i = 0; i < drivePdfList.length; i++) {
                var pdf = drivePdfList[i];
                pdf._originalIndex = i;
                if (searchTerm) {
                    var term = searchTerm.toLowerCase();
                    var match = (pdf.fileName || '').toLowerCase().indexOf(term) >= 0 ||
                                (pdf.hospital || '').toLowerCase().indexOf(term) >= 0 ||
                                (pdf.patientId || '').toLowerCase().indexOf(term) >= 0 ||
                                (pdf.patientName || '').toLowerCase().indexOf(term) >= 0 ||
                                (pdf.birthdate || '').toLowerCase().indexOf(term) >= 0;
                    if (!match) continue;
                }
                filteredPdfList.push(pdf);
            }

            var html = '<div class="pdf-search-bar"><input type="text" id="pdfSearchInput" placeholder="検索（医療機関名 / 患者ID / 患者名 / 生年月日）" value="' + escapeHtml(searchTerm) + '" oninput="renderPdfList()"></div>';
            html += '<div class="pdf-count">' + filteredPdfList.length + ' / ' + drivePdfList.length + ' 件のPDFファイル</div>';
            html += '<table><tr><th>ファイル名</th><th>医療機関名</th><th>患者ID</th><th>患者名</th><th>生年月日</th><th>更新日時</th><th style="width:70px">操作</th></tr>';
            for (var fi = 0; fi < filteredPdfList.length; fi++) {
                var pdf = filteredPdfList[fi];
                var isSelected = selectedDriveFile && selectedDriveFile.fileId === pdf.fileId;
                var rowClass = isSelected ? 'pdf-selected' : '';
                var cellClass = pdf.indexed ? 'indexed-cell' : 'not-indexed-cell';
                var badge = pdf.indexed === false ? '<span class="unindexed-badge">未</span>' : '';

                html += '<tr class="' + rowClass + '" onclick="selectFilteredPdf(' + fi + ')">';
                html += '<td>' + badge + escapeHtml(pdf.fileName) + '</td>';
                html += '<td class="' + cellClass + '">' + escapeHtml(pdf.hospital || '-') + '</td>';
                html += '<td class="' + cellClass + '">' + escapeHtml(pdf.patientId || '-') + '</td>';
                html += '<td class="' + cellClass + '">' + escapeHtml(pdf.patientName || '-') + '</td>';
                html += '<td class="' + cellClass + '">' + escapeHtml(pdf.birthdate || '-') + '</td>';
                html += '<td>' + escapeHtml(pdf.lastUpdated || '') + '</td>';
                var idxBtnClass = pdf.indexed ? 'btn-idx-inline btn-idx-rerun' : 'btn-idx-inline';
                var idxBtnLabel = pdf.indexed ? '再実行' : '実行';
                html += '<td><button class="' + idxBtnClass + '" onclick="event.stopPropagation(); indexOnePdf(\'' + pdf.fileId + '\', this)">' + idxBtnLabel + '</button></td>';
                html += '</tr>';
            }
            html += '</table>';
            area.innerHTML = html;

            // 検索ボックスにフォーカスを戻す
            var newSearch = area.querySelector('#pdfSearchInput');
            if (newSearch && searchTerm) {
                newSearch.focus();
                newSearch.setSelectionRange(searchTerm.length, searchTerm.length);
            }
        }

        // フィルタ済みリストからPDFを選択
        function selectFilteredPdf(filteredIndex) {
            var pdf = filteredPdfList[filteredIndex];
            var originalIndex = pdf._originalIndex;
            selectDrivePdf(originalIndex);
        }

        // 現在表示中のPDFインデックス（フィルタ済みリスト内の位置）
        var currentPdfIndex = -1;
        // 現在表示中のPDFのoriginalIndex（drivePdfList内の位置）
        var currentOriginalIndex = -1;

        function selectDrivePdf(originalIndex) {
            var pdf = drivePdfList[originalIndex];
            selectedDriveFile = { fileId: pdf.fileId, fileName: pdf.fileName };
            currentOriginalIndex = originalIndex;
            // フィルタ済みリスト内の位置を特定
            currentPdfIndex = -1;
            for (var i = 0; i < filteredPdfList.length; i++) {
                if (filteredPdfList[i]._originalIndex === originalIndex) {
                    currentPdfIndex = i;
                    break;
                }
            }
            renderPdfList();
            updateSaveButton();
            showPdfPreview(pdf.fileId, pdf.fileName);
            updatePdfNavButtons();
        }

        // PDF送り/逆送りナビゲーション（フィルタ済みリスト内で移動）
        function navigatePdf(direction) {
            if (filteredPdfList.length === 0) return;
            var newFilteredIndex = currentPdfIndex + direction;
            if (newFilteredIndex < 0 || newFilteredIndex >= filteredPdfList.length) return;
            var pdf = filteredPdfList[newFilteredIndex];
            selectDrivePdf(pdf._originalIndex);
            scrollPdfListToFilteredIndex(newFilteredIndex);
        }

        function updatePdfNavButtons() {
            var prevBtn = document.getElementById('pdfPrevBtn');
            var nextBtn = document.getElementById('pdfNextBtn');
            var counter = document.getElementById('pdfCounter');

            if (filteredPdfList.length === 0 || currentPdfIndex < 0) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                counter.textContent = '';
                return;
            }
            prevBtn.disabled = (currentPdfIndex <= 0);
            nextBtn.disabled = (currentPdfIndex >= filteredPdfList.length - 1);
            counter.textContent = (currentPdfIndex + 1) + ' / ' + filteredPdfList.length;
        }

        function scrollPdfListToFilteredIndex(filteredIndex) {
            var area = document.getElementById('pdfListArea');
            var rows = area.querySelectorAll('table tr');
            // +1 because first tr is header
            if (rows[filteredIndex + 1]) {
                rows[filteredIndex + 1].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function updateSaveButton() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = !(selectedNo && selectedDriveFile);

            // 抜去位置入力エリアの表示制御（No.とPDFの両方が選択されたら表示）
            var extArea = document.getElementById('extractionInputArea');
            if (selectedNo && selectedDriveFile) {
                extArea.className = 'extraction-input-area visible';
            } else {
                extArea.className = 'extraction-input-area';
            }

            // 選択サマリーを更新
            const summary = document.getElementById('selectionSummary');
            if (selectedNo || selectedDriveFile) {
                let html = '';
                if (selectedNo) {
                    const item = noListData.find(d => d.no === selectedNo);
                    html += '<strong>対象:</strong> No.' + selectedNo;
                    if (item && item.id) html += '　ID: ' + item.id;
                    if (item && item.hospital) html += '　' + item.hospital;
                }
                if (selectedDriveFile) {
                    html += '<br><strong>PDF:</strong> ' + escapeHtml(selectedDriveFile.fileName) + '（Google Drive）';
                }
                summary.innerHTML = html;
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }

        // === 抜去位置入力 ===
        function getExtractionPosition() {
            var parts = [];
            if (document.getElementById('extRight').checked) parts.push('右');
            if (document.getElementById('extLeft').checked) parts.push('左');
            if (document.getElementById('extUpper').checked) parts.push('上');
            if (document.getElementById('extLower').checked) parts.push('下');
            var num = document.getElementById('extNumber').value.trim();
            if (num) parts.push(num);
            return parts.join('');
        }

        function updateExtractionPreview() {
            var pos = getExtractionPosition();
            var preview = document.getElementById('extractionPreview');
            if (pos) {
                preview.innerHTML = '抜去位置: <strong>' + escapeHtml(pos) + '</strong>';
            } else {
                preview.innerHTML = '抜去位置: <strong>（未入力）</strong>';
            }
        }

        function resetExtractionInput() {
            document.getElementById('extRight').checked = false;
            document.getElementById('extLeft').checked = false;
            document.getElementById('extUpper').checked = false;
            document.getElementById('extLower').checked = false;
            document.getElementById('extNumber').value = '';
            updateExtractionPreview();
        }

        // ③ 紐づけ実行（Google Drive経由）
        async function executeLinkPdf() {
            if (!selectedNo || !selectedDriveFile) return;

            const resultArea = document.getElementById('resultArea');
            const saveBtn = document.getElementById('saveBtn');
            const extractionPosition = getExtractionPosition();

            var msg = 'No.' + selectedNo + ' に「' + selectedDriveFile.fileName + '」を紐づけます。\n';
            if (extractionPosition) {
                msg += '抜去位置: ' + extractionPosition + '\n';
            }
            msg += '（紐づけ後、PDFは完了フォルダへ移動されます）\n\nよろしいですか？';
            if (!confirm(msg)) return;

            saveBtn.disabled = true;
            saveBtn.textContent = '処理中...';
            resultArea.className = 'result info';
            resultArea.textContent = '紐づけ処理中...（スプレッドシート更新 → PDF移動）';
            resultArea.style.display = 'block';

            var params = {
                no: selectedNo,
                row: selectedRow,
                fileId: selectedDriveFile.fileId,
                fileName: encodeURIComponent(selectedDriveFile.fileName)
            };
            if (extractionPosition) {
                params.extractionPosition = encodeURIComponent(extractionPosition);
            }

            try {
                const result = await jsonpRequest('linkPdfFromDrive', params);

                if (result.success && result.data && result.data.success) {
                    resultArea.className = 'result success';
                    resultArea.innerHTML = '<strong>完了:</strong> ' + escapeHtml(result.data.message || '紐づけが完了しました');

                    // 選択状態をリセット
                    selectedDriveFile = null;

                    // 抜去位置入力をリセット
                    resetExtractionInput();

                    // PDFプレビューをクリア
                    clearPdfPreview();

                    // 一覧を再読み込み
                    loadNoList();
                    // PDF一覧も再読み込み（移動されたファイルが消える）
                    loadDrivePdfList();
                } else {
                    resultArea.className = 'result error';
                    resultArea.textContent = 'エラー: ' + ((result.data && result.data.message) || result.error || '不明なエラー');
                }

            } catch (err) {
                resultArea.className = 'result error';
                resultArea.textContent = 'エラー: ' + err.message;
            }

            saveBtn.disabled = false;
            saveBtn.textContent = '紐づける';
        }

        // キーボードショートカット（左右矢印でPDF送り）
        document.addEventListener('keydown', function(e) {
            // テキスト入力中は無効
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.key === 'ArrowLeft') {
                navigatePdf(-1);
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                navigatePdf(1);
                e.preventDefault();
            }
        });

        // JSONP リクエスト
        function jsonpRequest(action, params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                let url = APPS_SCRIPT_API_URL + '?action=' + action + '&callback=' + callbackName;
                for (const key in params) {
                    url += '&' + key + '=' + params[key];
                }

                window[callbackName] = function(result) {
                    delete window[callbackName];
                    document.head.removeChild(script);
                    clearTimeout(timeoutId);
                    resolve(result);
                };

                const timeoutId = setTimeout(function() {
                    delete window[callbackName];
                    if (script.parentNode) document.head.removeChild(script);
                    reject(new Error('タイムアウト'));
                }, 30000);

                const script = document.createElement('script');
                script.src = url;
                script.onerror = function() {
                    delete window[callbackName];
                    if (script.parentNode) document.head.removeChild(script);
                    clearTimeout(timeoutId);
                    reject(new Error('通信エラー'));
                };
                document.head.appendChild(script);
            });
        }

    </script>
</body>
</html>
