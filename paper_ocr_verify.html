<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紙回答の自動OCR＋照合支援</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif; background: #f5f5f5; color: #333; }

        .header {
            background: linear-gradient(135deg, #2196F3, #1565C0);
            color: white; padding: 16px 24px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .subtitle { font-size: 12px; opacity: 0.8; margin-left: auto; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }

        .card {
            background: white; border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            padding: 20px; margin-bottom: 16px;
        }
        .card-title {
            font-size: 15px; font-weight: 600; color: #1565C0;
            margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
        }
        .card-title .step {
            background: #1565C0; color: white; border-radius: 50%;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; flex-shrink: 0;
        }

        .btn {
            padding: 8px 20px; border: none; border-radius: 6px;
            font-size: 14px; cursor: pointer; font-weight: 500;
            transition: all 0.2s;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #1565C0; color: white; }
        .btn-primary:hover:not(:disabled) { background: #0d47a1; }
        .btn-orange { background: #e65100; color: white; }
        .btn-orange:hover:not(:disabled) { background: #bf360c; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-green:hover:not(:disabled) { background: #1b5e20; }
        .btn-sm { padding: 4px 12px; font-size: 12px; }

        .stats-bar {
            display: flex; gap: 16px; margin: 12px 0;
            padding: 10px 16px; background: #fff3e0; border-radius: 8px;
            font-size: 13px; flex-wrap: wrap;
        }
        .stats-bar .stat { display: flex; align-items: center; gap: 4px; }
        .stats-bar .stat-val { font-weight: 700; color: #e65100; }

        /* PDF一覧テーブル */
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .pdf-table th {
            background: #f5f5f5; padding: 8px 10px; text-align: left;
            border-bottom: 2px solid #e0e0e0; font-weight: 600; white-space: nowrap;
        }
        .pdf-table td {
            padding: 7px 10px; border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        .pdf-table tr:hover { background: #e3f2fd; }
        .pdf-table tr.selected { background: #bbdefb; }
        .pdf-table tr.qr-yes { opacity: 0.4; }

        .tag {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 11px; font-weight: 600;
        }
        .tag-paper { background: #fff3e0; color: #e65100; }
        .tag-qr { background: #e8f5e9; color: #2e7d32; }
        .tag-unknown { background: #f5f5f5; color: #999; }

        /* フィルタ */
        .filter-bar {
            display: flex; gap: 8px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;
        }
        .filter-bar label { font-size: 13px; font-weight: 500; }
        .filter-bar select, .filter-bar input {
            padding: 5px 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 13px;
        }

        /* プログレス */
        .progress-area { display: none; margin-top: 12px; }
        .progress-bar-wrap {
            background: #e0e0e0; border-radius: 8px; height: 24px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; background: linear-gradient(90deg, #1565C0, #42a5f5);
            border-radius: 8px; transition: width 0.3s;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 11px; font-weight: 600; min-width: 0;
        }
        .progress-text { font-size: 13px; margin-top: 6px; color: #555; }
        .progress-log {
            max-height: 200px; overflow-y: auto; margin-top: 8px;
            font-size: 12px; background: #fafafa; border: 1px solid #eee;
            border-radius: 6px; padding: 8px;
        }
        .log-ok { color: #2e7d32; }
        .log-err { color: #c62828; }
        .log-skip { color: #f57f17; }

        /* メッセージ */
        .msg { padding: 10px 16px; border-radius: 6px; margin-top: 10px; font-size: 13px; display: none; }
        .msg-success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .msg-error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .msg-info { background: #e3f2fd; color: #1565C0; border: 1px solid #bbdefb; }

        /* PDFプレビュー */
        .pdf-preview {
            margin-top: 12px; display: none;
            border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;
        }
        .pdf-preview iframe { width: 100%; height: 500px; border: none; }
    </style>
</head>
<body>
    <div class="header">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="28" height="28">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v16.5c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Zm3.75 11.625a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z"/>
        </svg>
        <h1>紙回答の自動OCR＋照合支援</h1>
        <span class="subtitle">QRコード未回答のPDFを抽出・OCR処理</span>
    </div>

    <div class="container">
        <!-- ステップ1: PDF一覧読み込み -->
        <div class="card">
            <div class="card-title">
                <span class="step">1</span>
                元PDFフォルダからPDF一覧を取得
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn btn-primary" id="btnLoadPdfs" onclick="loadPdfList()">Drive PDF一覧を読み込む</button>
                <button class="btn btn-orange" id="btnIndexUnprocessed" onclick="startBatchIndex()" disabled>
                    未処理を一括インデックス (<span id="unindexedCount">0</span>件)
                </button>
                <button class="btn btn-green" id="btnReindexAll" onclick="startReindexAll()" disabled>
                    全件再判定 (<span id="reindexCount">0</span>件)
                </button>
                <button class="btn btn-sm" style="background:#eee; color:#333;" id="btnStopIndex" onclick="stopBatchIndex()" style="display:none;">中止</button>
            </div>

            <div class="stats-bar" id="statsBar" style="display:none;">
                <div class="stat">合計: <span class="stat-val" id="statTotal">0</span>件</div>
                <div class="stat">インデックス済: <span class="stat-val" id="statIndexed">0</span>件</div>
                <div class="stat">未処理: <span class="stat-val" id="statUnindexed">0</span>件</div>
                <div class="stat">紙回答: <span class="stat-val" id="statPaper">0</span>件</div>
                <div class="stat">QR回答: <span class="stat-val" id="statQr">0</span>件</div>
            </div>

            <div class="progress-area" id="progressArea">
                <div class="progress-bar-wrap">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%;">0%</div>
                </div>
                <div class="progress-text" id="progressText"></div>
                <div class="progress-log" id="progressLog"></div>
            </div>

            <div class="msg" id="msgArea"></div>
        </div>

        <!-- ステップ2: フィルタ＋PDF一覧 -->
        <div class="card" id="listCard" style="display:none;">
            <div class="card-title">
                <span class="step">2</span>
                紙回答PDFの一覧（QRコード未チェック）
            </div>

            <div class="filter-bar">
                <label>表示:</label>
                <select id="filterType" onchange="renderPdfList()">
                    <option value="paper">紙回答のみ</option>
                    <option value="all">すべて</option>
                    <option value="qr">QR回答のみ</option>
                    <option value="unindexed">未処理のみ</option>
                </select>
                <input type="text" id="filterSearch" placeholder="検索（医療機関名/患者名/ID）" oninput="renderPdfList()" style="width: 250px;">
            </div>

            <div style="overflow-x: auto;">
                <table class="pdf-table" id="pdfTable">
                    <thead>
                        <tr>
                            <th style="width:30px;">#</th>
                            <th>ファイル名</th>
                            <th>医療機関名</th>
                            <th>患者ID</th>
                            <th>患者名</th>
                            <th>生年月日</th>
                            <th>回答方法</th>
                            <th>更新日時</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="pdfTableBody"></tbody>
                </table>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #888;" id="listCount"></div>

            <!-- PDFプレビュー -->
            <div class="pdf-preview" id="pdfPreview">
                <div style="padding: 8px 12px; background: #f5f5f5; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 13px; font-weight: 600;" id="previewTitle">PDFプレビュー</span>
                    <button class="btn btn-sm" style="background:#eee; color:#333;" onclick="closePdfPreview()">閉じる</button>
                </div>
                <iframe id="previewFrame" src=""></iframe>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_API_URL = 'https://script.google.com/a/macros/devine.co.jp/s/AKfycbxUNMDxhnGvotMWzlEsb14-EBqIyBDc_9phNQLQpD7Wzqbrubi610aprV6HSN0lVMF9yA/exec';

        let drivePdfList = [];
        let isIndexing = false;
        let stopIndexingFlag = false;

        // === JSONP API呼び出し ===
        function callApi(action, params, callback, timeoutMs) {
            timeoutMs = timeoutMs || 30000;
            var cbName = 'cb_' + action + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            var url = APPS_SCRIPT_API_URL + '?callback=' + cbName + '&action=' + action;
            if (params) {
                for (var k in params) {
                    url += '&' + k + '=' + encodeURIComponent(params[k]);
                }
            }
            var script;
            var timer = setTimeout(function() {
                delete window[cbName];
                if (script && script.parentNode) script.parentNode.removeChild(script);
                callback({ success: false, error: 'タイムアウト (' + (timeoutMs / 1000) + '秒)' });
            }, timeoutMs);

            window[cbName] = function(data) {
                clearTimeout(timer);
                delete window[cbName];
                if (script && script.parentNode) script.parentNode.removeChild(script);
                callback(data);
            };
            script = document.createElement('script');
            script.src = url;
            script.onerror = function() {
                clearTimeout(timer);
                delete window[cbName];
                if (script.parentNode) script.parentNode.removeChild(script);
                callback({ success: false, error: 'ネットワークエラー' });
            };
            document.head.appendChild(script);
        }

        // === PDF一覧読み込み ===
        function loadPdfList() {
            var btn = document.getElementById('btnLoadPdfs');
            btn.disabled = true;
            btn.textContent = '読み込み中...';
            showMsg('info', 'Google DriveからPDF一覧を取得中...');

            callApi('getDrivePdfList', null, function(data) {
                btn.disabled = false;
                btn.textContent = 'Drive PDF一覧を読み込む';

                if (!data.success) {
                    showMsg('error', 'PDF一覧の取得に失敗: ' + (data.error || '不明なエラー'));
                    return;
                }

                drivePdfList = data.data || [];
                showMsg('success', drivePdfList.length + '件のPDFを取得しました');
                updateStats();
                renderPdfList();
                document.getElementById('listCard').style.display = 'block';
            }, 60000);
        }

        // === 統計更新 ===
        function updateStats() {
            var total = drivePdfList.length;
            var indexed = 0, paper = 0, qr = 0;
            for (var i = 0; i < drivePdfList.length; i++) {
                if (drivePdfList[i].indexed) {
                    indexed++;
                    if (drivePdfList[i].qrCheckbox) {
                        qr++;
                    } else {
                        paper++;
                    }
                }
            }
            var unindexed = total - indexed;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statIndexed').textContent = indexed;
            document.getElementById('statUnindexed').textContent = unindexed;
            document.getElementById('statPaper').textContent = paper;
            document.getElementById('statQr').textContent = qr;
            document.getElementById('unindexedCount').textContent = unindexed;
            document.getElementById('statsBar').style.display = total > 0 ? 'flex' : 'none';

            var batchBtn = document.getElementById('btnIndexUnprocessed');
            batchBtn.disabled = (unindexed === 0) || isIndexing;

            document.getElementById('reindexCount').textContent = total;
            var reindexBtn = document.getElementById('btnReindexAll');
            reindexBtn.disabled = (total === 0) || isIndexing;
        }

        // === PDF一覧描画 ===
        function renderPdfList() {
            var filterType = document.getElementById('filterType').value;
            var searchText = document.getElementById('filterSearch').value.trim().toLowerCase();
            var tbody = document.getElementById('pdfTableBody');
            tbody.innerHTML = '';

            var filtered = [];
            for (var i = 0; i < drivePdfList.length; i++) {
                var pdf = drivePdfList[i];

                // フィルタ
                if (filterType === 'paper' && (pdf.qrCheckbox || !pdf.indexed)) continue;
                if (filterType === 'qr' && (!pdf.qrCheckbox || !pdf.indexed)) continue;
                if (filterType === 'unindexed' && pdf.indexed) continue;

                // 検索
                if (searchText) {
                    var haystack = [pdf.fileName, pdf.hospital, pdf.patientId, pdf.patientName, pdf.birthdate].join(' ').toLowerCase();
                    if (haystack.indexOf(searchText) < 0) continue;
                }

                filtered.push(pdf);
            }

            for (var j = 0; j < filtered.length; j++) {
                var p = filtered[j];
                var tr = document.createElement('tr');
                if (p.qrCheckbox) tr.className = 'qr-yes';

                var tagHtml;
                if (!p.indexed) {
                    tagHtml = '<span class="tag tag-unknown">未処理</span>';
                } else if (p.qrCheckbox) {
                    tagHtml = '<span class="tag tag-qr">QR回答</span>';
                } else {
                    tagHtml = '<span class="tag tag-paper">紙回答</span>';
                }

                var actionHtml = '';
                if (!p.indexed) {
                    actionHtml = '<button class="btn btn-sm btn-primary" onclick="indexOnePdf(\'' + p.fileId + '\', this)">インデックス</button>';
                } else {
                    actionHtml = '<button class="btn btn-sm" style="background:#e3f2fd; color:#1565C0;" onclick="previewPdf(\'' + p.fileId + '\', \'' + escapeHtml(p.fileName) + '\')">プレビュー</button> ' +
                        '<button class="btn btn-sm" style="background:#fff3e0; color:#e65100;" onclick="indexOnePdf(\'' + p.fileId + '\', this)">再判定</button>';
                }

                tr.innerHTML =
                    '<td>' + (j + 1) + '</td>' +
                    '<td style="font-size:12px; max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="' + escapeHtml(p.fileName) + '">' + escapeHtml(p.fileName) + '</td>' +
                    '<td>' + escapeHtml(p.hospital || '') + '</td>' +
                    '<td>' + escapeHtml(p.patientId || '') + '</td>' +
                    '<td>' + escapeHtml(p.patientName || '') + '</td>' +
                    '<td style="white-space:nowrap;">' + escapeHtml(p.birthdate || '') + '</td>' +
                    '<td>' + tagHtml + '</td>' +
                    '<td style="font-size:11px; color:#888; white-space:nowrap;">' + escapeHtml(p.modifiedDate || '') + '</td>' +
                    '<td>' + actionHtml + '</td>';
                tbody.appendChild(tr);
            }

            document.getElementById('listCount').textContent =
                filtered.length + ' / ' + drivePdfList.length + '件表示中';
        }

        // === 個別インデックス ===
        function indexOnePdf(fileId, btnEl) {
            if (btnEl) {
                btnEl.disabled = true;
                btnEl.textContent = '処理中...';
            }
            callApi('indexPdfWithGemini', { fileId: fileId }, function(data) {
                if (!data.success || !data.data || !data.data.success) {
                    var msg = (data.data && data.data.message) || data.error || 'インデックスエラー';
                    showMsg('error', msg);
                    if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'インデックス'; }
                    return;
                }
                var r = data.data;
                for (var i = 0; i < drivePdfList.length; i++) {
                    if (drivePdfList[i].fileId === fileId) {
                        drivePdfList[i].indexed = true;
                        drivePdfList[i].hospital = r.ocrData.hospital || '';
                        drivePdfList[i].patientId = r.ocrData.patientId || '';
                        drivePdfList[i].patientName = r.ocrData.patientName || '';
                        drivePdfList[i].birthdate = r.ocrData.birthdate || '';
                        drivePdfList[i].qrCheckbox = r.ocrData.qrCheckbox === true;
                        break;
                    }
                }
                updateStats();
                renderPdfList();
                showMsg('success', (r.fileName || '') + ' のインデックスが完了しました');
            }, 120000);
        }

        // === 一括インデックス ===
        function startBatchIndex() {
            var unindexed = drivePdfList.filter(function(p) { return !p.indexed; });
            if (unindexed.length === 0) return;

            isIndexing = true;
            stopIndexingFlag = false;
            document.getElementById('btnIndexUnprocessed').disabled = true;
            document.getElementById('btnLoadPdfs').disabled = true;

            var progressArea = document.getElementById('progressArea');
            var progressBar = document.getElementById('progressBar');
            var progressText = document.getElementById('progressText');
            var progressLog = document.getElementById('progressLog');
            progressArea.style.display = 'block';
            progressLog.innerHTML = '';

            var total = unindexed.length;
            var current = 0;
            var successCount = 0;
            var errorCount = 0;

            function processNext() {
                if (stopIndexingFlag || current >= total) {
                    var status = stopIndexingFlag ? '中止しました' : '完了';
                    progressText.textContent = status + ': ' + successCount + '件成功 / ' + errorCount + '件エラー';
                    progressBar.style.width = '100%';
                    progressBar.textContent = stopIndexingFlag ? '中止' : '100%';
                    isIndexing = false;
                    stopIndexingFlag = false;
                    document.getElementById('btnLoadPdfs').disabled = false;
                    updateStats();
                    return;
                }

                var pdf = unindexed[current];
                if (pdf.indexed) {
                    current++;
                    setTimeout(processNext, 50);
                    return;
                }

                var pct = Math.round((current / total) * 100);
                progressText.textContent = '処理中 (' + (current + 1) + '/' + total + '): ' + pdf.fileName;
                progressBar.style.width = pct + '%';
                progressBar.textContent = pct + '%';

                callApi('indexPdfWithGemini', { fileId: pdf.fileId }, function(data) {
                    current++;
                    var logDiv = document.createElement('div');

                    if (data.success && data.data && data.data.success) {
                        successCount++;
                        var r = data.data;
                        var qrLabel = r.ocrData.qrCheckbox ? 'QR' : '紙';
                        logDiv.className = 'log-ok';
                        logDiv.textContent = '[OK] ' + pdf.fileName + ' → ' +
                            (r.ocrData.hospital || '?') + ' / ' +
                            (r.ocrData.patientName || '?') + ' [' + qrLabel + ']';
                        for (var i = 0; i < drivePdfList.length; i++) {
                            if (drivePdfList[i].fileId === pdf.fileId) {
                                drivePdfList[i].indexed = true;
                                drivePdfList[i].hospital = r.ocrData.hospital || '';
                                drivePdfList[i].patientId = r.ocrData.patientId || '';
                                drivePdfList[i].patientName = r.ocrData.patientName || '';
                                drivePdfList[i].birthdate = r.ocrData.birthdate || '';
                                drivePdfList[i].qrCheckbox = r.ocrData.qrCheckbox === true;
                                break;
                            }
                        }
                    } else {
                        errorCount++;
                        var msg = (data.data && data.data.message) || data.error || 'エラー';
                        logDiv.className = 'log-err';
                        logDiv.textContent = '[ERR] ' + pdf.fileName + ': ' + msg;
                    }

                    progressLog.appendChild(logDiv);
                    progressLog.scrollTop = progressLog.scrollHeight;
                    renderPdfList();
                    updateStats();
                    setTimeout(processNext, 300);
                }, 120000);
            }

            processNext();
        }

        function stopBatchIndex() {
            stopIndexingFlag = true;
        }

        // === 全件再判定（インデックス済みも含めて再実行） ===
        function startReindexAll() {
            var targets = drivePdfList.slice(); // 全件
            if (targets.length === 0) return;

            if (!confirm('全' + targets.length + '件を再インデックスします。\nGemini APIを使用するため時間がかかります。\n実行しますか？')) return;

            isIndexing = true;
            stopIndexingFlag = false;
            document.getElementById('btnReindexAll').disabled = true;
            document.getElementById('btnIndexUnprocessed').disabled = true;
            document.getElementById('btnLoadPdfs').disabled = true;

            var progressArea = document.getElementById('progressArea');
            var progressBar = document.getElementById('progressBar');
            var progressText = document.getElementById('progressText');
            var progressLog = document.getElementById('progressLog');
            progressArea.style.display = 'block';
            progressLog.innerHTML = '';

            var total = targets.length;
            var current = 0;
            var successCount = 0;
            var errorCount = 0;

            function processNext() {
                if (stopIndexingFlag || current >= total) {
                    var status = stopIndexingFlag ? '中止しました' : '完了';
                    progressText.textContent = status + ': ' + successCount + '件成功 / ' + errorCount + '件エラー';
                    progressBar.style.width = '100%';
                    progressBar.textContent = stopIndexingFlag ? '中止' : '100%';
                    isIndexing = false;
                    stopIndexingFlag = false;
                    document.getElementById('btnLoadPdfs').disabled = false;
                    updateStats();
                    return;
                }

                var pdf = targets[current];
                var pct = Math.round((current / total) * 100);
                progressText.textContent = '再判定中 (' + (current + 1) + '/' + total + '): ' + pdf.fileName;
                progressBar.style.width = pct + '%';
                progressBar.textContent = pct + '%';

                callApi('indexPdfWithGemini', { fileId: pdf.fileId }, function(data) {
                    current++;
                    var logDiv = document.createElement('div');

                    if (data.success && data.data && data.data.success) {
                        successCount++;
                        var r = data.data;
                        var qrLabel = r.ocrData.qrCheckbox ? 'QR' : '紙';
                        logDiv.className = 'log-ok';
                        logDiv.textContent = '[OK] ' + pdf.fileName + ' → ' +
                            (r.ocrData.hospital || '?') + ' / ' +
                            (r.ocrData.patientName || '?') + ' [' + qrLabel + ']';
                        for (var i = 0; i < drivePdfList.length; i++) {
                            if (drivePdfList[i].fileId === pdf.fileId) {
                                drivePdfList[i].indexed = true;
                                drivePdfList[i].hospital = r.ocrData.hospital || '';
                                drivePdfList[i].patientId = r.ocrData.patientId || '';
                                drivePdfList[i].patientName = r.ocrData.patientName || '';
                                drivePdfList[i].birthdate = r.ocrData.birthdate || '';
                                drivePdfList[i].qrCheckbox = r.ocrData.qrCheckbox === true;
                                break;
                            }
                        }
                    } else {
                        errorCount++;
                        var msg = (data.data && data.data.message) || data.error || 'エラー';
                        logDiv.className = 'log-err';
                        logDiv.textContent = '[ERR] ' + pdf.fileName + ': ' + msg;
                    }

                    progressLog.appendChild(logDiv);
                    progressLog.scrollTop = progressLog.scrollHeight;
                    renderPdfList();
                    updateStats();
                    setTimeout(processNext, 300);
                }, 120000);
            }

            processNext();
        }

        // === PDFプレビュー ===
        function previewPdf(fileId, fileName) {
            var preview = document.getElementById('pdfPreview');
            var frame = document.getElementById('previewFrame');
            var title = document.getElementById('previewTitle');
            title.textContent = 'PDFプレビュー: ' + fileName;
            frame.src = 'https://drive.google.com/file/d/' + fileId + '/preview';
            preview.style.display = 'block';
            preview.scrollIntoView({ behavior: 'smooth' });
        }

        function closePdfPreview() {
            var preview = document.getElementById('pdfPreview');
            var frame = document.getElementById('previewFrame');
            frame.src = '';
            preview.style.display = 'none';
        }

        // === ユーティリティ ===
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function showMsg(type, message) {
            var area = document.getElementById('msgArea');
            area.className = 'msg msg-' + type;
            area.textContent = message;
            area.style.display = 'block';
            if (type === 'success') {
                setTimeout(function() { area.style.display = 'none'; }, 5000);
            }
        }
    </script>
</body>
</html>
