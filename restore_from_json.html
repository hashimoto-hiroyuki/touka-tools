<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON復元ツール</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #f5f7fa;
            color: #333;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .step-title {
            font-weight: bold;
            font-size: 1.05em;
            margin-bottom: 12px;
            color: #444;
        }
        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: #4285f4;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #3367d6;
        }
        .btn-danger {
            background: #ea4335;
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background: #c5221f;
        }
        .btn-success {
            background: #34a853;
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background: #2d8f47;
        }
        .file-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.15s;
        }
        .file-item:last-child { border-bottom: none; }
        .file-item:hover { background: #f0f4ff; }
        .file-item.selected { background: #e3f0ff; }
        .file-item input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .file-name {
            flex: 1;
            font-size: 0.95em;
        }
        .file-no {
            font-weight: bold;
            color: #4285f4;
            margin-right: 10px;
            min-width: 50px;
        }
        .file-date {
            color: #888;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .select-controls {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        .select-controls button {
            padding: 4px 12px;
            font-size: 0.85em;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .select-controls button:hover {
            background: #f0f0f0;
        }
        .count-info {
            margin-top: 8px;
            color: #666;
            font-size: 0.9em;
        }
        .result {
            padding: 14px 18px;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .result.info { background: #e8f0fe; color: #1967d2; display: block; }
        .result.success { background: #e6f4ea; color: #137333; display: block; }
        .result.error { background: #fce8e6; color: #c5221f; display: block; }
        .result.warning { background: #fef7e0; color: #b06000; display: block; }
        .detail-list {
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.85em;
        }
        .detail-item {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        .detail-item .status-restored { color: #34a853; font-weight: bold; }
        .detail-item .status-skipped { color: #f9ab00; font-weight: bold; }
        .detail-item .status-error { color: #ea4335; font-weight: bold; }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 0.9em;
            color: #856404;
        }
        .loading {
            text-align: center;
            padding: 30px;
            color: #888;
        }
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #ddd;
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>🔄 JSON復元ツール</h1>
    <p class="subtitle">アンケートJSONフォルダからスプレッドシートのデータを復元します</p>

    <div class="warning-box">
        ⚠️ <strong>注意:</strong> このツールはJSONファイルから回答データ1シートにデータを書き戻します。
        既にシートに同じNo.のデータがある場合はスキップされます。
    </div>

    <!-- Step 1: JSONファイル一覧読み込み -->
    <div class="card">
        <div class="step-title">① JSONファイル一覧を読み込み</div>
        <button class="btn btn-primary" id="loadBtn" onclick="loadJsonFiles()">一覧を読み込む</button>
        <div id="loadResult"></div>
        <div id="fileListArea"></div>
    </div>

    <!-- Step 2: 復元実行 -->
    <div class="card">
        <div class="step-title">② 復元を実行</div>
        <p style="color:#666; font-size:0.9em; margin-bottom:12px;">
            選択したJSONファイルのデータを回答データ1シートに復元します。
        </p>
        <button class="btn btn-success" id="restoreBtn" onclick="executeRestore()" disabled>
            選択したファイルを復元する
        </button>
        <div id="restoreResult"></div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/a/macros/devine.co.jp/s/AKfycbxelFju5HQlJWUaTsB-FT1mITgc2WnXX22h_LC7D8Ycy2fgFTXuethp8pUbsQThfqhYKg/exec';

        let jsonFiles = [];
        let selectedFileIds = new Set();

        // === JSONP API呼び出し ===
        function callApi(action, params, callback, timeoutMs) {
            timeoutMs = timeoutMs || 30000;
            var cbName = 'cb_' + action + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            var url = API_URL + '?action=' + encodeURIComponent(action) + '&callback=' + cbName;
            if (params) {
                for (var key in params) {
                    url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
                }
            }
            var script = document.createElement('script');
            var timer = setTimeout(function() {
                cleanup();
                callback({ success: false, error: 'タイムアウト（' + (timeoutMs/1000) + '秒）' });
            }, timeoutMs);

            function cleanup() {
                clearTimeout(timer);
                delete window[cbName];
                if (script.parentNode) script.parentNode.removeChild(script);
            }

            window[cbName] = function(data) {
                cleanup();
                callback(data);
            };
            script.src = url;
            script.onerror = function() {
                cleanup();
                callback({ success: false, error: 'ネットワークエラー' });
            };
            document.body.appendChild(script);
        }

        // JSONファイル一覧を読み込み
        function loadJsonFiles() {
            var btn = document.getElementById('loadBtn');
            var result = document.getElementById('loadResult');
            var listArea = document.getElementById('fileListArea');

            btn.disabled = true;
            btn.textContent = '読み込み中...';
            result.className = 'result info';
            result.style.display = 'block';
            result.innerHTML = '<span class="spinner"></span> JSONファイル一覧を取得中...';
            listArea.innerHTML = '';

            callApi('getJsonFilesForRestore', {}, function(response) {
                btn.disabled = false;
                btn.textContent = '一覧を読み込む';

                if (response.success && response.data) {
                    jsonFiles = response.data.files || [];
                    result.className = 'result success';
                    result.textContent = jsonFiles.length + '件のJSONファイルが見つかりました。';
                    renderFileList();
                } else {
                    result.className = 'result error';
                    result.textContent = 'エラー: ' + (response.error || '不明なエラー');
                }
            }, 30000);
        }

        // ファイル一覧を描画
        function renderFileList() {
            var listArea = document.getElementById('fileListArea');
            if (jsonFiles.length === 0) {
                listArea.innerHTML = '<p style="color:#888; margin-top:10px;">JSONファイルがありません。</p>';
                updateRestoreButton();
                return;
            }

            var html = '<div class="select-controls">';
            html += '<button onclick="selectAll()">全選択</button>';
            html += '<button onclick="selectNone()">全解除</button>';
            html += '</div>';
            html += '<div class="count-info" id="selectedCount">0件選択中</div>';
            html += '<div class="file-list">';
            for (var i = 0; i < jsonFiles.length; i++) {
                var f = jsonFiles[i];
                var checked = selectedFileIds.has(f.fileId) ? 'checked' : '';
                var date = f.lastUpdated ? new Date(f.lastUpdated).toLocaleString('ja-JP') : '';
                html += '<div class="file-item' + (checked ? ' selected' : '') + '" onclick="toggleFile(\'' + f.fileId + '\', this)">';
                html += '<input type="checkbox" ' + checked + ' onclick="event.stopPropagation(); toggleFile(\'' + f.fileId + '\', this.parentElement)">';
                html += '<span class="file-no">' + (f.no !== null ? 'No.' + f.no : '-') + '</span>';
                html += '<span class="file-name">' + escapeHtml(f.fileName) + '</span>';
                html += '<span class="file-date">' + date + '</span>';
                html += '</div>';
            }
            html += '</div>';
            listArea.innerHTML = html;
            updateSelectedCount();
            updateRestoreButton();
        }

        // チェック切り替え
        function toggleFile(fileId, rowEl) {
            if (selectedFileIds.has(fileId)) {
                selectedFileIds.delete(fileId);
                rowEl.classList.remove('selected');
                rowEl.querySelector('input[type="checkbox"]').checked = false;
            } else {
                selectedFileIds.add(fileId);
                rowEl.classList.add('selected');
                rowEl.querySelector('input[type="checkbox"]').checked = true;
            }
            updateSelectedCount();
            updateRestoreButton();
        }

        // 全選択
        function selectAll() {
            selectedFileIds.clear();
            jsonFiles.forEach(function(f) { selectedFileIds.add(f.fileId); });
            renderFileList();
        }

        // 全解除
        function selectNone() {
            selectedFileIds.clear();
            renderFileList();
        }

        // 選択数表示更新
        function updateSelectedCount() {
            var el = document.getElementById('selectedCount');
            if (el) el.textContent = selectedFileIds.size + '件選択中';
        }

        // 復元ボタン有効/無効
        function updateRestoreButton() {
            var btn = document.getElementById('restoreBtn');
            btn.disabled = selectedFileIds.size === 0;
            btn.textContent = selectedFileIds.size > 0
                ? selectedFileIds.size + '件を復元する'
                : '選択したファイルを復元する';
        }

        // 復元実行
        function executeRestore() {
            if (selectedFileIds.size === 0) return;

            var count = selectedFileIds.size;
            if (!confirm(count + '件のJSONファイルからデータを復元します。\n\n既にシートに同じNo.がある場合はスキップされます。\n\n実行しますか？')) {
                return;
            }

            var btn = document.getElementById('restoreBtn');
            var result = document.getElementById('restoreResult');

            btn.disabled = true;
            btn.textContent = '復元処理中...';
            result.className = 'result info';
            result.style.display = 'block';
            result.innerHTML = '<span class="spinner"></span> 復元処理中... しばらくお待ちください。';

            var fileIdList = Array.from(selectedFileIds).join(',');

            callApi('restoreFromJson', { fileIds: fileIdList }, function(response) {
                btn.disabled = false;
                updateRestoreButton();

                if (response.success && response.data && response.data.success) {
                    var d = response.data;
                    result.className = 'result success';
                    var html = '<strong>復元完了:</strong> ' + d.message;

                    if (d.details && d.details.length > 0) {
                        html += '<div class="detail-list">';
                        for (var i = 0; i < d.details.length; i++) {
                            var item = d.details[i];
                            html += '<div class="detail-item">';
                            html += '<span class="status-' + item.status + '">[' +
                                (item.status === 'restored' ? '復元' : item.status === 'skipped' ? 'スキップ' : 'エラー') + ']</span> ';
                            html += escapeHtml(item.fileName);
                            if (item.reason) html += ' — ' + escapeHtml(item.reason);
                            if (item.row) html += ' → 行' + item.row;
                            if (item.error) html += ' — ' + escapeHtml(item.error);
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    result.innerHTML = html;
                } else {
                    result.className = 'result error';
                    result.textContent = 'エラー: ' + (response.error || (response.data && response.data.message) || '不明なエラー');
                }
            }, 120000);  // 復元は時間がかかるので2分タイムアウト
        }

        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
    </script>
</body>
</html>
